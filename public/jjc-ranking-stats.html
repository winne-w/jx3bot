<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>竞技场心法排名统计（实时）</title>
    <style>
        :root {
            --bg: #f6efe9;
            --bg-accent: #f2d8c2;
            --ink: #2b2420;
            --muted: #6b5f57;
            --card: #fff7f2;
            --stroke: rgba(43, 36, 32, 0.12);
            --accent: #b8572c;
            --accent-2: #1f6f8b;
            --shadow: 0 18px 40px rgba(43, 36, 32, 0.12);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            color: var(--ink);
            font-family: "STZhongsong", "KaiTi", "Noto Serif SC", serif;
            background:
                radial-gradient(circle at 15% 10%, rgba(241, 200, 170, 0.65), transparent 55%),
                radial-gradient(circle at 85% 0%, rgba(178, 216, 230, 0.5), transparent 60%),
                linear-gradient(145deg, var(--bg), #fff);
            min-height: 100vh;
            padding: 36px 24px 60px;
        }

        .page {
            max-width: 1180px;
            margin: 0 auto;
            position: relative;
        }

        .page::before {
            content: "";
            position: absolute;
            inset: -20px;
            background: repeating-linear-gradient(
                130deg,
                rgba(255, 255, 255, 0.4),
                rgba(255, 255, 255, 0.4) 1px,
                transparent 1px,
                transparent 18px
            );
            border-radius: 32px;
            z-index: -1;
        }

        header {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 24px 28px;
            border-radius: 28px;
            background: rgba(255, 255, 255, 0.86);
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        .title {
            font-size: clamp(1.6rem, 2.6vw, 2.4rem);
            letter-spacing: 6px;
            font-weight: 700;
        }

        .subtitle {
            color: var(--muted);
            font-size: 0.98rem;
            display: flex;
            flex-wrap: wrap;
            gap: 10px 18px;
        }

        .meta {
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }

        .meta-card {
            border-radius: 16px;
            padding: 12px 14px;
            background: var(--card);
            border: 1px solid var(--stroke);
            font-size: 0.92rem;
            color: var(--muted);
        }

        .meta-card strong {
            display: block;
            color: var(--ink);
            font-size: 1.04rem;
            margin-bottom: 6px;
            letter-spacing: 1px;
        }

        .status {
            margin-top: 18px;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 0.95rem;
            background: rgba(255, 255, 255, 0.8);
            border: 1px dashed rgba(43, 36, 32, 0.2);
            color: var(--muted);
        }

        .grid {
            margin-top: 28px;
            display: grid;
            gap: 24px;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }

        .range-card {
            background: var(--card);
            border-radius: 20px;
            padding: 18px 18px 22px;
            border: 1px solid var(--stroke);
            box-shadow: 0 12px 30px rgba(43, 36, 32, 0.08);
        }

        .range-title {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            margin-bottom: 12px;
            gap: 10px;
        }

        .range-title h3 {
            margin: 0;
            font-size: 1.1rem;
            letter-spacing: 2px;
        }

        .range-title span {
            color: var(--muted);
            font-size: 0.85rem;
        }

        .lane {
            margin-top: 12px;
        }

        .lane-title {
            font-size: 0.98rem;
            font-weight: 600;
            color: var(--accent-2);
            margin-bottom: 8px;
        }

        .bar-row {
            display: grid;
            grid-template-columns: 72px 1fr 52px 60px;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .bar-row:last-child {
            margin-bottom: 0;
        }

        .bar {
            height: 16px;
            border-radius: 999px;
            background: linear-gradient(90deg, rgba(184, 87, 44, 0.15), rgba(184, 87, 44, 0.75));
            position: relative;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            border-radius: inherit;
            background: linear-gradient(90deg, var(--accent), #f39f6d);
            transition: width 0.4s ease;
        }

        .bar-value {
            font-weight: 700;
            color: var(--ink);
            text-align: right;
        }

        .bar-percent {
            color: var(--muted);
            text-align: right;
            font-size: 0.84rem;
        }

        .muted {
            color: var(--muted);
        }

        .error {
            color: #8a2d2d;
        }

        @media (max-width: 700px) {
            body {
                padding: 20px 14px 40px;
            }

            header {
                padding: 18px;
            }

            .bar-row {
                grid-template-columns: 64px 1fr 48px 56px;
            }
        }
    </style>
</head>
<body>
    <div class="page">
        <header>
            <div class="title">竞技场心法排名统计</div>
            <div class="subtitle" id="subtitle">
                <span class="muted">正在加载实时数据...</span>
            </div>
            <div class="status" id="status">正在请求统计接口</div>
        </header>

        <section class="grid" id="grid"></section>
    </div>

    <script>
        const BASE_API = "jjc_ranking_stats.php";
        const DEFAULT_LIST_API = `${BASE_API}?action=list`;
        const DEFAULT_READ_API = `${BASE_API}?action=read`;
        const params = new URLSearchParams(window.location.search);
        const listApiUrl = params.get("list_api") || DEFAULT_LIST_API;
        const readApiBase = params.get("api") || DEFAULT_READ_API;
        const initialTimestamp = params.get("timestamp");

        const rangeConfigs = [
            { key: "top_1000", label: "前1000" },
            { key: "top_200", label: "前200" },
            { key: "top_100", label: "前100" },
            { key: "top_50", label: "前50" },
        ];

        const subtitle = document.getElementById("subtitle");
        const grid = document.getElementById("grid");
        const statusNode = document.getElementById("status");

        const listContainer = document.createElement("div");
        listContainer.className = "status";
        listContainer.id = "list-status";
        listContainer.innerHTML = `
            <label class="muted" for="date-select">可用日期：</label>
            <select id="date-select" disabled></select>
        `;
        statusNode.insertAdjacentElement("afterend", listContainer);
        const dateSelect = listContainer.querySelector("#date-select");

        function formatTime(timestamp) {
            if (!timestamp) {
                return "未知时间";
            }
            const date = new Date(timestamp * 1000);
            if (Number.isNaN(date.getTime())) {
                return "未知时间";
            }
            return date.toLocaleString("zh-CN", {
                hour12: false,
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
            });
        }

        function setStatus(message, type) {
            statusNode.textContent = message;
            statusNode.classList.toggle("error", type === "error");
        }

        function renderDateList(timestamps) {
            if (!Array.isArray(timestamps) || timestamps.length === 0) {
                listContainer.textContent = "暂无可用日期数据";
                return;
            }
            const items = timestamps
                .filter((value) => Number.isFinite(Number(value)))
                .sort((a, b) => Number(b) - Number(a))
                .map((value) => ({
                    value: String(value),
                    label: formatTime(Number(value)),
                }));
            if (!items.length) {
                listContainer.textContent = "暂无可用日期数据";
                return;
            }

            dateSelect.innerHTML = items
                .map((item) => `<option value="${item.value}">${item.label}</option>`)
                .join("");
            dateSelect.disabled = false;

            const selected = initialTimestamp && items.some((item) => item.value === String(initialTimestamp))
                ? String(initialTimestamp)
                : items[0].value;
            dateSelect.value = selected;
        }

        function renderList(list, validCount) {
            const maxCount = list.reduce((maxValue, item) => Math.max(maxValue, item[1]), 1);
            return list.map(([kungfu, count]) => {
                const percent = validCount > 0 ? (count / validCount) * 100 : 0;
                return `
                    <div class="bar-row">
                        <div>${kungfu}</div>
                        <div class="bar">
                            <div class="bar-fill" style="width:${(count / maxCount) * 100}%"></div>
                        </div>
                        <div class="bar-value">${count}</div>
                        <div class="bar-percent">${percent.toFixed(1)}%</div>
                    </div>
                `;
            }).join("");
        }

        function renderRangeCard(rangeLabel, stats) {
            const healer = stats.healer || {};
            const dps = stats.dps || {};
            const minScore = healer.min_score ?? dps.min_score ?? "-";
            const healerList = healer.list || [];
            const dpsList = dps.list || [];

            return `
                <div class="range-card">
                    <div class="range-title">
                        <h3>${rangeLabel} 心法分布</h3>
                        <span>最低分数：${minScore}</span>
                    </div>
                    <div class="lane">
                        <div class="lane-title">奶妈（${healer.valid_count ?? 0}）</div>
                        ${healerList.length ? renderList(healerList, healer.valid_count || 0) : "<div class='muted'>暂无奶妈数据</div>"}
                    </div>
                    <div class="lane">
                        <div class="lane-title">DPS（${dps.valid_count ?? 0}）</div>
                        ${dpsList.length ? renderList(dpsList, dps.valid_count || 0) : "<div class='muted'>暂无DPS数据</div>"}
                    </div>
                </div>
            `;
        }

        function render(data) {
            const seasonLabel = data.current_season ? `${data.current_season}${data.week_info || ""}` : (data.week_info || "-");
            subtitle.innerHTML = `
                <span>赛季：${seasonLabel || "-"}</span>
                <span>榜单时间：${formatTime(data.ranking_cache_time || data.generated_at)}</span>
            `;

            const stats = data.kungfu_statistics || {};
            grid.innerHTML = rangeConfigs
                .filter((item) => stats[item.key])
                .map((item) => renderRangeCard(item.label, stats[item.key]))
                .join("");

            if (!grid.innerHTML) {
                grid.innerHTML = "<div class='range-card'>暂无统计数据</div>";
            }
        }

        function buildReadUrl(timestamp) {
            const hasQuery = readApiBase.includes("?");
            const joiner = hasQuery ? "&" : "?";
            return `${readApiBase}${joiner}timestamp=${encodeURIComponent(timestamp)}`;
        }

        async function loadStats(timestamp) {
            if (!timestamp) {
                setStatus("缺少 timestamp 参数，无法读取统计数据", "error");
                return;
            }
            const apiUrl = buildReadUrl(timestamp);
            setStatus(`请求接口：${apiUrl}`);
            try {
                const response = await fetch(apiUrl, { cache: "no-store" });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                render(data);
                setStatus("数据加载完成");
            } catch (error) {
                setStatus(`获取统计失败：${error.message || error}`, "error");
            }
        }

        async function loadDateList() {
            try {
                const response = await fetch(listApiUrl, { cache: "no-store" });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                renderDateList(data);
                if (dateSelect && dateSelect.value) {
                    loadStats(dateSelect.value);
                }
            } catch (error) {
                listContainer.textContent = `获取日期列表失败：${error.message || error}`;
                listContainer.classList.add("error");
            }
        }

        loadDateList();
        if (initialTimestamp) {
            loadStats(initialTimestamp);
        }

        if (dateSelect) {
            dateSelect.addEventListener("change", (event) => {
                const value = event.target.value;
                if (value) {
                    loadStats(value);
                }
            });
        }
    </script>
</body>
</html>
